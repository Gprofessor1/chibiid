<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì¹˜ë¹„ì¦ëª…ì‚¬ì§„ ë©”ì´ì»¤</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Gowun+Dodum&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Gowun Dodum', sans-serif;
            -webkit-tap-highlight-color: transparent;
        }
        .main-card {
            transition: opacity 0.5s ease-in-out;
        }
        .view {
            display: none;
        }
        .view-active {
            display: block;
        }
        .upload-zone {
            border: 3px dashed #a3d5ff;
            background-color: #f0f8ff;
        }
        .upload-zone.dragover {
            border-color: #005a9c;
            background-color: #e6f3ff;
        }
        .history-thumbnail {
            width: 64px;
            height: 64px;
            object-fit: cover;
            border: 3px solid transparent;
            cursor: pointer;
            transition: all 0.2s ease-in-out;
        }
        .history-thumbnail.selected {
            border-color: #4a90e2;
            transform: scale(1.1);
        }
        .loader {
            border-top-color: #4a90e2;
            animation: spin 1s ease-in-out infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .footer-credit {
            position: fixed;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            padding: 5px 10px;
            background-color: rgba(0, 0, 0, 0.5);
            color: white;
            font-size: 12px;
            border-radius: 12px;
            z-index: 100;
            text-align: center;
        }
    </style>
</head>
<body class="bg-[#f0f8ff] flex items-center justify-center min-h-screen p-4">
    
    <div id="main-card" class="w-full max-w-md mx-auto bg-white rounded-2xl shadow-xl p-6 md:p-8 space-y-6">
        
        <!-- ì•± ì œëª© -->
        <div class="text-center">
            <h1 class="text-3xl md:text-4xl font-bold text-[#005a9c]">ì¹˜ë¹„ì¦ëª…ì‚¬ì§„ ë©”ì´ì»¤ ğŸ¨</h1>
            <p class="text-gray-500 mt-2">AIë¡œ ë§Œë“œëŠ” ë‚˜ë§Œì˜ ê·€ì—¬ìš´ ìºë¦­í„°!</p>
        </div>

        <!-- ì—ëŸ¬ ë©”ì‹œì§€ ì˜ì—­ -->
        <div id="error-message" class="hidden bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg relative" role="alert">
            <strong class="font-bold">ì•—! ë¬¸ì œ ë°œìƒ ğŸ˜¥</strong>
            <span class="block sm:inline" id="error-text">ë¬¸ì œê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.</span>
        </div>

        <!-- 0. API í‚¤ ì…ë ¥ í™”ë©´ -->
        <div id="api-key-view" class="view space-y-4">
            <h2 class="text-lg font-semibold text-center text-gray-700">ì‹œì‘í•˜ê¸° ì „ì—! ğŸ”‘</h2>
            <p class="text-center text-sm text-gray-500">Gemini API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.</p>
            <input type="password" id="api-key-input" placeholder="ì—¬ê¸°ì— API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”" class="w-full border-2 border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-[#4a90e2] focus:border-[#4a90e2] transition">
            <button id="save-api-key-button" class="w-full bg-[#4a90e2] text-white font-bold py-4 px-6 rounded-xl text-lg hover:bg-[#005a9c] hover:shadow-lg transition-all transform hover:scale-105">ì €ì¥í•˜ê³  ì‹œì‘í•˜ê¸°! âœ¨</button>
        </div>

        <!-- 1. ì‚¬ì§„ ì—…ë¡œë“œ í™”ë©´ -->
        <div id="upload-view" class="view">
            <div id="upload-zone" class="upload-zone rounded-xl p-10 text-center cursor-pointer transition">
                <input type="file" id="file-input" class="hidden" accept="image/jpeg, image/png, image/jpg">
                <div class="flex flex-col items-center text-[#005a9c]">
                    <svg class="w-16 h-16 mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12"></path></svg>
                    <p class="font-semibold text-lg">ì‚¬ì§„ì„ ëŒì–´ì˜¤ê±°ë‚˜ í´ë¦­! ğŸ“¸</p>
                    <p class="text-xs mt-1">JPG, PNG íŒŒì¼ / 10MB ì´í•˜</p>
                </div>
            </div>
        </div>

        <!-- 2. ë¡œë”© í™”ë©´ -->
        <div id="loading-view" class="view text-center py-10">
            <div class="loader w-20 h-20 rounded-full border-8 border-gray-200 inline-block"></div>
            <p class="text-gray-600 text-lg mt-6 animate-pulse">ìºë¦­í„° ë³€ì‹  ì¤‘... ì–! ğŸ§™â€â™‚ï¸</p>
            <p class="text-gray-500 text-sm mt-2">AIê°€ ì—´ì‹¬íˆ ê·¸ë¦¼ì„ ê·¸ë¦¬ê³  ìˆì–´ìš”!<br>(ìµœëŒ€ 1ë¶„ ì •ë„ ê±¸ë¦´ ìˆ˜ ìˆì–´ìš”)</p>
        </div>

        <!-- 3. ê²°ê³¼ í™”ë©´ -->
        <div id="result-view" class="view space-y-4">
            <div class="border-4 border-[#005a9c] rounded-xl flex items-center justify-center aspect-square overflow-hidden bg-gray-100">
                <img id="result-image" src="" alt="ìƒì„±ëœ ì¹˜ë¹„ ìºë¦­í„°" class="max-w-full max-h-full object-contain">
            </div>
            <div class="space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <button id="regenerate-button" class="w-full bg-gray-600 text-white font-bold py-3 px-4 rounded-xl hover:bg-gray-700 transition transform hover:scale-105">ë‹¤ì‹œ ë§Œë“¤ê¸° ğŸ¨</button>
                    <button id="start-over-button" class="w-full bg-gray-200 text-gray-800 font-bold py-3 px-4 rounded-xl hover:bg-gray-300 transition transform hover:scale-105">ì²˜ìŒìœ¼ë¡œ ğŸš€</button>
                </div>
                <input type="text" id="filename-input" placeholder="íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•´ìš” (ì˜ˆ: ê¹€ë©‹ìŸ_ìºë¦­í„°)" class="w-full border-2 border-gray-300 p-3 rounded-xl focus:ring-2 focus:ring-[#4a90e2] focus:border-[#4a90e2] transition">
                <button id="download-button" class="w-full bg-[#4a90e2] text-white font-bold py-4 px-4 text-lg rounded-xl hover:bg-[#005a9c] transition disabled:bg-blue-300 disabled:cursor-not-allowed disabled:transform-none transform hover:scale-105">ë‹¤ìš´ë¡œë“œ ğŸ“¥</button>
            </div>
        </div>

        <!-- ìƒì„± ê¸°ë¡ -->
        <div id="history-container" class="hidden">
            <h3 class="text-md font-bold text-gray-600 mb-2">ë‚´ê°€ ë§Œë“  ìºë¦­í„°ë“¤ ğŸ–¼ï¸</h3>
            <div id="history-gallery" class="flex flex-wrap gap-2 bg-gray-100 p-2 rounded-lg">
                <!-- ì¸ë„¤ì¼ì´ ì—¬ê¸°ì— ì¶”ê°€ë©ë‹ˆë‹¤. -->
            </div>
        </div>
    </div>
    
    <div class="footer-credit">
        /* Made BLACKHOLE GWONZZANGğŸ˜blog.naver.com/banggahj */
    </div>

    <script>
        const mainCard = document.getElementById('main-card');
        const views = {
            apiKey: document.getElementById('api-key-view'),
            upload: document.getElementById('upload-view'),
            loading: document.getElementById('loading-view'),
            result: document.getElementById('result-view'),
        };
        
        const apiKeyInput = document.getElementById('api-key-input');
        const saveApiKeyButton = document.getElementById('save-api-key-button');
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');
        const resultImage = document.getElementById('result-image');
        const regenerateButton = document.getElementById('regenerate-button');
        const downloadButton = document.getElementById('download-button');
        const filenameInput = document.getElementById('filename-input');
        const startOverButton = document.getElementById('start-over-button');
        
        const errorMessage = document.getElementById('error-message');
        const errorText = document.getElementById('error-text');

        const historyContainer = document.getElementById('history-container');
        const historyGallery = document.getElementById('history-gallery');

        let userApiKey = null;
        let originalImageBase64 = null;
        let generatedImageBase64 = null;
        let generationHistory = [];

        function showView(viewName) {
            mainCard.style.opacity = 0;
            setTimeout(() => {
                Object.values(views).forEach(view => view.classList.remove('view-active'));
                views[viewName].classList.add('view-active');
                mainCard.style.opacity = 1;
            }, 500);
        }
        
        function loadApiKey() {
            const savedKey = localStorage.getItem('geminiApiKey');
            if (savedKey) {
                userApiKey = savedKey;
                showView('upload');
            } else {
                showView('apiKey');
            }
        }

        function saveApiKey() {
            const key = apiKeyInput.value.trim();
            if (key && key.length > 20) { // Basic check for key format
                userApiKey = key;
                localStorage.setItem('geminiApiKey', key);
                showView('upload');
                hideError();
            } else {
                showError("ì˜¬ë°”ë¥¸ API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”!");
            }
        }
        
        saveApiKeyButton.addEventListener('click', saveApiKey);

        uploadZone.addEventListener('click', () => fileInput.click());
        fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, preventDefaults, false);
        });

        function preventDefaults(e) {
            e.preventDefault();
            e.stopPropagation();
        }

        ['dragenter', 'dragover'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => uploadZone.classList.add('dragover'), false);
        });

        ['dragleave', 'drop'].forEach(eventName => {
            uploadZone.addEventListener(eventName, () => uploadZone.classList.remove('dragover'), false);
        });

        uploadZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]), false);

        function handleFile(file) {
            if (!file) return;
            if (file.size > 10 * 1024 * 1024) { // 10MB
                showError("íŒŒì¼ì´ ë„ˆë¬´ ì»¤ìš”! 10MB ì´í•˜ë¡œ ì¤„ì—¬ì£¼ì„¸ìš”.");
                return;
            }
            if (!['image/jpeg', 'image/png', 'image/jpg'].includes(file.type)) {
                showError("JPG ë˜ëŠ” PNG íŒŒì¼ë§Œ ì˜¬ë¦´ ìˆ˜ ìˆì–´ìš”.");
                return;
            }
            hideError();
            const reader = new FileReader();
            reader.onload = (e) => {
                originalImageBase64 = e.target.result.split(',')[1];
                generateChibi(originalImageBase64);
            };
            reader.readAsDataURL(file);
        }

        async function generateChibi(imageBase64) {
            if (!userApiKey) {
                showError("API í‚¤ê°€ ì„¤ì •ë˜ì§€ ì•Šì•˜ì–´ìš”. API í‚¤ë¥¼ ë¨¼ì € ì…ë ¥í•´ì£¼ì„¸ìš”.");
                showView('apiKey');
                return;
            }
            showView('loading');
            
            regenerateButton.disabled = true;
            startOverButton.disabled = true;
            
            // --- AI í”„ë¡¬í”„íŠ¸ ìˆ˜ì • ---
            const userPrompt = `A super cute and happy chibi character ID photo, based on the uploaded image. Make it in a bright and colorful Japanese anime style, perfect for a student ID card. ğŸ¨ Key features: The entire art style must use very bold and thick black line art for ALL parts of the character, including the hair, eyes, clothes, and the main outline. This gives it a strong, clean, sticker-like look. Big, sparkling eyes with shiny highlights âœ¨, a sweet smile ğŸ˜Š, and soft rosy cheeks. The background must be plain white for a clear ID photo look. The final image should be very high quality, adorable, and friendly.`;
            
            const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-image-preview:generateContent?key=${userApiKey}`;

            const payload = {
                contents: [{
                    parts: [{ text: userPrompt }, { inlineData: { mimeType: "image/png", data: imageBase64 } }]
                }],
                generationConfig: {
                    responseModalities: ['IMAGE']
                },
            };

            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 60000); // 60 seconds timeout

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    signal: controller.signal // Add abort signal
                });
                
                clearTimeout(timeoutId); // Clear timeout if fetch is successful

                if (!response.ok) {
                    const errorBody = await response.json();
                    const errorMessage = errorBody.error?.message || `HTTP error! status: ${response.status}`;
                    console.error("API Error Body:", errorBody);
                    throw new Error(errorMessage);
                }

                const result = await response.json();
                const base64Data = result?.candidates?.[0]?.content?.parts?.find(p => p.inlineData)?.inlineData?.data;

                if (!base64Data) {
                    throw new Error("AI ëª¨ë¸ì´ ì´ë¯¸ì§€ë¥¼ ë§Œë“¤ì§€ ëª»í–ˆì–´ìš”. ğŸ˜¢");
                }

                generatedImageBase64 = base64Data;
                resultImage.src = `data:image/png;base64,${generatedImageBase64}`;
                showView('result');
                addToHistory(generatedImageBase64);
                
                startOverButton.disabled = false;
                let cooldown = 5;
                regenerateButton.textContent = `ì ì‹œ í›„ (${cooldown}ì´ˆ)`;
                const cooldownInterval = setInterval(() => {
                    cooldown--;
                    regenerateButton.textContent = `ì ì‹œ í›„ (${cooldown}ì´ˆ)`;
                    if (cooldown <= 0) {
                        clearInterval(cooldownInterval);
                        regenerateButton.disabled = false;
                        regenerateButton.textContent = 'ë‹¤ì‹œ ë§Œë“¤ê¸° ğŸ¨';
                    }
                }, 1000);

            } catch (error) {
                clearTimeout(timeoutId);
                console.error("Error generating chibi:", error);
                
                if (error.name === 'AbortError') {
                    showError("ì‹œê°„ì´ ë„ˆë¬´ ì˜¤ë˜ ê±¸ë ¤ ìš”ì²­ì„ ì¤‘ë‹¨í–ˆì–´ìš”. ë„¤íŠ¸ì›Œí¬ ìƒíƒœë¥¼ í™•ì¸í•˜ê±°ë‚˜ ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } else if (error.message && error.message.toLowerCase().includes('api key not valid')) {
                    showError("API í‚¤ê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ë§Œë£Œë˜ì—ˆì–´ìš”. í‚¤ë¥¼ í™•ì¸í•˜ê³  ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } else if (error.message && error.message.includes('429')) {
                    showError("ìš”ì²­ì´ ë„ˆë¬´ ë§ì•„ìš”! ğŸš€ 1ë¶„ ì •ë„ í›„ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                } else {
                    showError("ìºë¦­í„°ë¥¼ ë§Œë“¤ë‹¤ê°€ ë¬¸ì œê°€ ìƒê²¼ì–´ìš”. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                }
                resetApp(false);

            } finally {
                if (!regenerateButton.textContent.includes('ì ì‹œ í›„')) {
                    regenerateButton.disabled = false;
                    regenerateButton.textContent = 'ë‹¤ì‹œ ë§Œë“¤ê¸° ğŸ¨';
                }
                 startOverButton.disabled = false;
            }
        }
        
        regenerateButton.addEventListener('click', () => {
             if(originalImageBase64) {
                 hideError();
                 generateChibi(originalImageBase64)
             }
        });

        filenameInput.addEventListener('input', () => {
            downloadButton.disabled = filenameInput.value.trim() === '';
        });

        downloadButton.addEventListener('click', () => {
            if (generatedImageBase64) {
                const filename = (filenameInput.value.trim() || 'chibi_character') + '.png';
                
                try {
                    const blob = base64ToBlob(generatedImageBase64, 'image/png');
                    const blobUrl = URL.createObjectURL(blob);

                    const link = document.createElement('a');
                    link.href = blobUrl;
                    link.download = filename;
                    
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    URL.revokeObjectURL(blobUrl);
                } catch (e) {
                    console.error("Download failed:", e);
                    showError("ë‹¤ìš´ë¡œë“œì— ì‹¤íŒ¨í–ˆì–´ìš”. ë¸Œë¼ìš°ì € ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
                }
            }
        });
        
        startOverButton.addEventListener('click', () => {
            resetApp(false); // Keep history
        });

        function resetApp(clearHistory = false) {
             originalImageBase64 = null;
             generatedImageBase64 = null;
             fileInput.value = '';
             filenameInput.value = '';
             downloadButton.disabled = true;
             if (clearHistory) {
                 generationHistory = [];
                 renderHistory();
             }
             if (userApiKey) {
                showView('upload');
             } else {
                showView('apiKey');
             }
        }

        function showError(message) {
            errorText.textContent = message;
            errorMessage.classList.remove('hidden');
        }

        function hideError() {
            errorMessage.classList.add('hidden');
        }

        function base64ToBlob(base64, mimeType) {
            const byteCharacters = atob(base64);
            const byteNumbers = new Array(byteCharacters.length);
            for (let i = 0; i < byteCharacters.length; i++) {
                byteNumbers[i] = byteCharacters.charCodeAt(i);
            }
            const byteArray = new Uint8Array(byteNumbers);
            return new Blob([byteArray], { type: mimeType });
        }

        function addToHistory(imageBase64) {
            generationHistory.unshift(imageBase64);
            if (generationHistory.length > 10) {
                generationHistory.pop();
            }
            renderHistory();
        }

        function renderHistory() {
            historyGallery.innerHTML = ''; 
            if (generationHistory.length > 0) {
                historyContainer.classList.remove('hidden');
                generationHistory.forEach((imgBase64) => {
                    const img = document.createElement('img');
                    img.src = `data:image/png;base64,${imgBase64}`;
                    img.classList.add('history-thumbnail', 'rounded-md');
                    if (imgBase64 === generatedImageBase64) {
                         img.classList.add('selected');
                    }
                    img.addEventListener('click', () => {
                        generatedImageBase64 = imgBase64;
                        resultImage.src = img.src;
                        document.querySelectorAll('.history-thumbnail').forEach(thumb => thumb.classList.remove('selected'));
                        img.classList.add('selected');
                    });
                    historyGallery.appendChild(img);
                });
            } else {
                historyContainer.classList.add('hidden');
            }
        }
        
        // Initial setup
        loadApiKey();

    </script>
</body>
</html>

